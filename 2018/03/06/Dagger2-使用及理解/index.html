<html>
  <head>
    <title>Dagger2 使用及理解 - learnice</title>
    <link href='/images/fav.png' rel='shortcut icon'>
<link href='/atom.xml' rel='alternate' type='application/rss+xml'>
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/responsive.css">
<script src="/js/jquery.js"></script>
<script src="/js/basics.js"></script>
<meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'>
<meta content='text/html; charset=utf-8' http-equiv='content-type'>


  </head>
  <body>
    <header>
  <a id='go-back-home' href='/'><img src='/images/scribble.png' alt='Home' width='66' height='66'></a>
  <p>learnice</p>
  <p>不忘初心</p>
</header>

    <div id='container'>
      <div class='block'>
  
    <a class='main' href='/'>Home</a>
  
    <a class='main' href='mailto:learnice.he@gmail.com'>Email</a>
  
    <a class='main' href='https://github.com/learnice'>Github</a>
  
    <a class='main' href='/about'>About</a>
  
</div>

      <section class='paging'>
  
  
    <div class='right'>
      <a href='/2018/03/04/Retrofit-源码阅读/'>
        ›
      </a>
    </div>
  
</section>

      <div class='content'>
        <section class='post'>
          <h1>
            <div class='date'>2018-03-06</div>
            Dagger2 使用及理解
          </h1>
          <p>### </p>
<h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>最早的版本 Dagger1 由 Square 公司开发。依赖注入框架主要用于模块间解耦，提高代码的健壮性和可维护性。Dagger 这个库的取名不仅仅来自它的本意“匕首”同时也暗示了它的原理。Dagger2 是一个 Android 依赖注入框架，由谷歌开发。</p>
<h4 id="它到底有何优势"><a href="#它到底有何优势" class="headerlink" title="它到底有何优势"></a>它到底有何优势</h4><p><strong>1.增加开发效率、省去重复的简单体力劳动</strong></p>
<p>首先 new 一个实例的过程是一个重复的简单体力劳动，dagger2 完全可以把new一个实例的工作做了，因此我们把主要精力集中在关键业务上、同时也能增加开发效率上。省去写单例的方法，并且也不需要担心自己写的单例方法是否线程安全，自己写的单例是懒汉模式还是饿汉模式。因为 dagger2 都可以把这些工作做了。</p>
<p><strong>2.更好的管理类实例</strong></p>
<p>每个 app 中的 ApplicationComponent 管理整个 app 的全局类实例，所有的全局类实例都统一交给 ApplicationComponent管理，并且它们的生命周期与 app 的生命周期一样。<br>每个页面对应自己的 Component，页面 Component 管理着自己页面所依赖的所有类实例。<br>因为 Component，Module，整个 app 的类实例结构变的很清晰。</p>
<p><strong>3.解耦</strong></p>
<p>假如不用 dagger2 的话，一个类的 new 代码是非常可能充斥在 app 的多个类中的，假如该类的构造函数发生变化，那这些涉及到的类都得进行修改。设计模式中提倡把容易变化的部分封装起来。</p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>举个栗子：Android  开发中注入 Presenter </p>
<p>先创建一个简单的示例项目</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//mvp 中的协议接口</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DaggerContract</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">View</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">updateUI</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Presenter</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">loadData</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Activity </span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaggerActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">DaggerContract</span>.<span class="title">View</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> TextView textView;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_dagger);</div><div class="line">        textView = findViewById(R.id.txt);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUI</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// presenter</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaggerPresenter</span> <span class="keyword">implements</span> <span class="title">DaggerContract</span>.<span class="title">Presenter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DaggerPresenter</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadData</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>dagger2 注入依赖有几种不同的方式</strong></p>
<ol>
<li>在需要注入依赖的地方添加 <code>@inject</code> ，然后在依赖的构造函数上添加 <code>@inject</code> (假如这个依赖不需要其它依赖)</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 在DaggerActivity中添加</span></div><div class="line"><span class="meta">@Inject</span></div><div class="line">DaggerPresenter mPresenter;</div><div class="line"><span class="comment">// 然后在 DaggerPresenter 的构造函数上添加</span></div><div class="line"><span class="meta">@Inject</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">DaggerPresenter</span><span class="params">()</span> </span>&#123;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 新建一个 DaggerComponent </span></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DaggerComponent</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(DaggerActivity daggerActivity)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后 make 一下 DaggerActivity 就可使用 DaggerPresenter 啦！还是很神奇的！Dagger 会根据注解找到被注解的构造函数，然后 new 出一个对象赋值给 mPresenter</p>
<ol>
<li><p>使用 dagger 中的 mdoule 提供依赖。Presenter 中是必须有 Activity 的引用的（要不然没法玩），但是我们并没有办法在 Activity 的构造函数上添加 <code>@inject</code> ，这里就需要一个能够提供提供依赖的东西了，再 Dagger 中它就是 Module，修改一下代码</p>
<p>​</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 添加 DaggerContract.View 成员属性</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaggerPresenter</span> <span class="keyword">implements</span> <span class="title">DaggerContract</span>.<span class="title">Presenter</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> DaggerContract.View mView;</div><div class="line">    </div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DaggerPresenter</span><span class="params">(DaggerContract.View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.mView = view;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadData</span><span class="params">()</span> </span>&#123;</div><div class="line">        mView.updateUI();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 这个时候 DaggerPresenter 的构造就需要 DaggerContract.View 依赖</span></div><div class="line"><span class="comment">// 新建 DaggerModule </span></div><div class="line"><span class="meta">@Module</span>   <span class="comment">// 类要使用 @Module 注解</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaggerModule</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> DaggerContract.View view;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DaggerModule</span><span class="params">(DaggerContract.View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.view = view;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Provides</span> <span class="comment">// @Provides 注解的方法用来提供 DaggerContract.View 对象</span></div><div class="line">    DaggerContract.<span class="function">View <span class="title">provideView</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> view;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//修改 DaggerComponent 代码</span></div><div class="line"><span class="meta">@Component</span>(modules = DaggerModule.class)  <span class="comment">// 添加modules</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DaggerComponent</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(DaggerActivity daggerActivity)</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// make 项目</span></div><div class="line"><span class="comment">//修改 DaggerActivity 的 oncreate 方法</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_dagger);</div><div class="line">        textView = findViewById(R.id.txt);</div><div class="line">        DaggerDaggerComponent.builder()</div><div class="line">                .daggerModule(<span class="keyword">new</span> DaggerModule(<span class="keyword">this</span>))</div><div class="line">                .build()</div><div class="line">                .inject(<span class="keyword">this</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>执行完成后我们就可以在 DaggerActivity 使用 mPresenter 啦！</p>
<p>这个还是有一个地方不妥，那就是注入的 Presenter 对象是 <code>DaggerPresenter</code>,而类之间应该依赖于接口，继续修改代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 可以肯定的是仅仅在 DaggerActivity 中这么修改是不行的。这样的话，dagger 并不能找到DaggerContract.Presenter 的构造函数，它只是一个接口。这里就需要我们直接在 module 中去提供一个依赖了</span></div><div class="line"><span class="meta">@Inject</span>  DaggerPresenter mPresenter 修改为 <span class="meta">@Inject</span> DaggerContract.Presenter mPresenter;</div><div class="line"><span class="comment">//直接修改 DaggerModule 代码</span></div><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaggerModule</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> DaggerContract.View view;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DaggerModule</span><span class="params">(DaggerContract.View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.view = view;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Provides</span>  <span class="comment">// 这里提供 DaggerContract.Presenter 依赖</span></div><div class="line">    DaggerContract.<span class="function">Presenter <span class="title">providePresenter</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DaggerPresenter(view);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在的话整体上 MVP 就显示的合理了！</p>
<ol>
<li><p>component 可以提供依赖。如果说所有的 Activity 中都需要 SharedPreferences，而且全局只需要一个，这时我们可以利用 Application 来构建一个，然后可以方便的注入到各个 Activity 中。</p>
<p>​</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 新建 Appcontext extends Application</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppContext</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 新建 AppModule 提供相关依赖，这里的成员 AppContext 和上面的 DaggerActivity 一样，</span></div><div class="line"><span class="comment">// 它们都没有办法注解构造函数</span></div><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> AppContext appContext;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AppModule</span><span class="params">(AppContext appContext)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.appContext = appContext;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Provides</span>  <span class="comment">// 提供 SharedPreferences </span></div><div class="line">    <span class="function">SharedPreferences <span class="title">provideSP</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> appContext.getSharedPreferences(<span class="string">"app"</span>, Context.MODE_PRIVATE);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 新建 AppComponent ，并且暴露出可以提供的依赖 SharedPreferences </span></div><div class="line"><span class="meta">@Component</span>(modules = AppModule.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AppComponent</span> </span>&#123;</div><div class="line">    <span class="function">SharedPreferences <span class="title">getSP</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// make 项目</span></div><div class="line"><span class="comment">// 修改 AppContext 代码</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppContext</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AppComponent appComponent;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AppContext instance;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        instance = <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="comment">// 在 Application 中 AppComponent 保持单例</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AppComponent <span class="title">getAppComponent</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (appComponent == <span class="keyword">null</span>) &#123;</div><div class="line">            appComponent = DaggerAppComponent.builder()</div><div class="line">                    .appModule(<span class="keyword">new</span> AppModule(instance))</div><div class="line">                    .build();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> appComponent;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 修改 DaggerComponent 代码，添加对 AppComponent 组建依赖</span></div><div class="line"><span class="meta">@Component</span>(modules = DaggerModule.class, dependencies = AppComponent.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DaggerComponent</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(DaggerActivity daggerActivity)</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 然后修改 DaggerActivity 代码，就可以将 SharedPreferences 注入到 DaggerActivity 中</span></div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    SharedPreferences sharedPreferences;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_dagger);</div><div class="line">        textView = findViewById(R.id.txt);</div><div class="line">        DaggerDaggerComponent.builder()</div><div class="line">                .daggerModule(<span class="keyword">new</span> DaggerModule(<span class="keyword">this</span>))</div><div class="line">                .appComponent(AppContext.getAppComponent())  <span class="comment">// 添加依赖组件</span></div><div class="line">                .build()</div><div class="line">                .inject(<span class="keyword">this</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h4 id="关于-Scope-的使用"><a href="#关于-Scope-的使用" class="headerlink" title="关于 Scope 的使用"></a>关于 Scope 的使用</h4><p>在说 Scope 之前先做一个小实验，修改 DaggerActivity 代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaggerActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">DaggerContract</span>.<span class="title">View</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = DaggerActivity.class.getSimpleName();</div><div class="line">    <span class="keyword">private</span> TextView textView;</div><div class="line"></div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    DaggerContract.Presenter mPresenter;</div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    DaggerContract.Presenter mPresenter_2;  <span class="comment">// 新注入一个 mPresenter_2</span></div><div class="line"></div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    SharedPreferences sharedPreferences;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_dagger);</div><div class="line">        textView = findViewById(R.id.txt);</div><div class="line">        DaggerDaggerComponent.builder()</div><div class="line">                .daggerModule(<span class="keyword">new</span> DaggerModule(<span class="keyword">this</span>))</div><div class="line">                .appComponent(AppContext.getAppComponent())</div><div class="line">                .build()</div><div class="line">                .inject(<span class="keyword">this</span>);</div><div class="line">        <span class="comment">// 这里打印一下俩个类</span></div><div class="line">        Log.v(TAG, mPresenter.toString());</div><div class="line">        Log.v(TAG, mPresenter_2.toString());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUI</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行看结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">---------------.DaggerPresenter@<span class="number">6</span>b42602</div><div class="line">---------------.DaggerPresenter@<span class="number">5</span>d4fb13</div></pre></td></tr></table></figure>
<p>很明显这两个对象不相同</p>
<p><strong>原因？</strong> 看看 dagger 源码分析一下，打开 DaggerDaggerComponent 源码（只看 DaggerModule 相关的）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// DaggerDaggerComponent 用的是 builder 模式，我们根据调用它的过程看</span></div><div class="line"><span class="comment">// 看看这几行代码都做了什么</span></div><div class="line">DaggerDaggerComponent.builder()</div><div class="line">                .daggerModule(<span class="keyword">new</span> DaggerModule(<span class="keyword">this</span>))</div><div class="line">                .appComponent(AppContext.getAppComponent())</div><div class="line">                .build()</div><div class="line">                .inject(<span class="keyword">this</span>);</div><div class="line"></div><div class="line"><span class="comment">// builder 模式的套路  直接看 static Builder 类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> DaggerModule daggerModule;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line">			<span class="comment">// 构建出来 DaggerDaggerComponent</span></div><div class="line">        <span class="function"><span class="keyword">public</span> DaggerComponent <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DaggerDaggerComponent(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">		<span class="comment">// 给 daggerModule 赋值</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">daggerModule</span><span class="params">(DaggerModule daggerModule)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.daggerModule = Preconditions.checkNotNull(daggerModule);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="comment">// 贴一下之前写的 DaggerModule 下面也会用到</span></div><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaggerModule</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> DaggerContract.View view;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DaggerModule</span><span class="params">(DaggerContract.View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.view = view;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Provides</span></div><div class="line">    DaggerContract.<span class="function">Presenter <span class="title">provideView</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DaggerPresenter(view);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 然后看看 initialize 方法  </span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(<span class="keyword">final</span> Builder builder)</span> </span>&#123;</div><div class="line">        <span class="comment">// 调用 DaggerModule_ProvideViewFactory 工厂方法</span></div><div class="line">        <span class="keyword">this</span>.provideViewProvider = DaggerModule_ProvideViewFactory.create(builder.daggerModule);</div><div class="line">        <span class="comment">// 生成一个成员注入器 一样的工厂方法，传入 provideViewProvider</span></div><div class="line">        <span class="keyword">this</span>.daggerActivityMembersInjector =</div><div class="line">                DaggerActivity_MembersInjector.create(provideViewProvider);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="comment">//看看 inject 方法</span></div><div class="line"> <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(DaggerActivity daggerActivity)</span> </span>&#123;</div><div class="line">        <span class="comment">// 给 daggerActivity 注入依赖</span></div><div class="line">        daggerActivityMembersInjector.injectMembers(daggerActivity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="comment">// 接着看 injectMembers</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">injectMembers</span><span class="params">(DaggerActivity instance)</span> </span>&#123;</div><div class="line">      <span class="comment">// 看到端倪没有，没有？接着往下看</span></div><div class="line">    instance.mPresenter = mPresenterAndMPresenter_2Provider.get();</div><div class="line">    instance.mPresenter_2 = mPresenterAndMPresenter_2Provider.get();</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="comment">// 这里的 mPresenterAndMPresenter_2Provider 就是上面构建 daggerActivityMembersInjector 传入的</span></div><div class="line"><span class="comment">// 看看 mPresenterAndMPresenter_2Provider 的 get 方法</span></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="keyword">public</span> DaggerContract.<span class="function">Presenter <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Preconditions.checkNotNull( </div><div class="line">        <span class="keyword">module</span>.provideView(), <span class="string">"Cannot return null from a non-@Nullable @Provides method"</span>);</div><div class="line">  &#125;</div><div class="line"><span class="comment">// 这里的 module 就是 DaggerModule，它的 provideView 方法会 new 出一个新的 DaggerPresenter 对象</span></div><div class="line"><span class="comment">// 所以这就是为啥两个类不同的原因</span></div></pre></td></tr></table></figure>
<p>什么？你想让注入的两个对象变成同一个对象？好，这里就要用上 Scope 了。Scope 的意思就是 “范围”，在 dagger 使用 Scope 可以保证注入到环境中的依赖的单例性（前提是要配置正确）</p>
<p>新建一个  Scope  注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Scope</span></div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ActivityScope &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后在需要约束的依赖的 provide 方法上、Component 接口上添加 Scope 注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaggerModule</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> DaggerContract.View view;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DaggerModule</span><span class="params">(DaggerContract.View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.view = view;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@ActivityScope</span>   <span class="comment">// 添加注解</span></div><div class="line">    <span class="meta">@Provides</span></div><div class="line">    DaggerContract.<span class="function">Presenter <span class="title">provideView</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DaggerPresenter(view);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@ActivityScope</span>  <span class="comment">// 添加注解</span></div><div class="line"><span class="meta">@Component</span>(modules = DaggerModule.class, dependencies = AppComponent.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DaggerComponent</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inject</span><span class="params">(DaggerActivity daggerActivity)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行代码，看结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">--------.DaggerPresenter@6b42602</div><div class="line">--------.DaggerPresenter@6b42602</div></pre></td></tr></table></figure>
<p>注入的两个对象果然相同了！为什么呢？继续看源码！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 直接看 DaggerDaggerComponent 的  initialize 方法</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(<span class="keyword">final</span> Builder builder)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.provideViewProvider =</div><div class="line">        DoubleCheck.provider(DaggerModule_ProvideViewFactory.create(builder.daggerModule));</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.getSPProvider = <span class="keyword">new</span> cn_learnicehe_dagger2test_di_AppComponent_getSP(builder.appComponent);</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.daggerActivityMembersInjector =</div><div class="line">        DaggerActivity_MembersInjector.create(provideViewProvider, getSPProvider);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p> <code>DoubleCheck.provider()</code> 生成一个 DoubleCheck 对象。这个一个委托机制，传入的对象就是被委托的对象，接着看它的 get 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>) <span class="comment">// cast only happens when result comes from the provider</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">  Object result = instance;</div><div class="line">  <span class="keyword">if</span> (result == UNINITIALIZED) &#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">      result = instance;   </div><div class="line">      <span class="keyword">if</span> (result == UNINITIALIZED) &#123;</div><div class="line">        result = provider.get();   <span class="comment">// 如果没有被初始化，调用被委托对象的 get 方法，如果已经初始化直接返回，不再调用 get</span></div><div class="line">       	................</div><div class="line">        instance = result;  <span class="comment">// 然后将实例保存</span></div><div class="line">        <span class="comment">/* Null out the reference to the provider. We are never going to need it again, so we</span></div><div class="line">         * can make it eligible for GC. */</div><div class="line">        provider = <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> (T) result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>dagger2 基本用法就是这些了，也够用了。不得不说，想要学会使用 dagger2 要经历 “从入门到放弃再到入门” 的过程。</p>

          <br>
<p>learnice</p>
<p><img src='/images/scribble3.png' alt='scribble'  width='33' height='33'></p>

        </section>
      </div>
      
      <div class='block'>
  
    <a class='main' href='/'>Home</a>
  
    <a class='main' href='mailto:learnice.he@gmail.com'>Email</a>
  
    <a class='main' href='https://github.com/learnice'>Github</a>
  
    <a class='main' href='/about'>About</a>
  
</div>

    </div>
    <footer>
  <span class='muted'>learnice</span><br>
  <br>
  <br>
</footer>

  </body>
</html>
